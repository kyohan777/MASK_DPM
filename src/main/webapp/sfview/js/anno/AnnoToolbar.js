import Anno from"/sfview/js/anno/Anno.js";import Text from"/sfview/js/anno/Text.js";export default class AnnoToolbar{static $view;static init($view){this.$view=$view;$(".anno.tb li, .anno.radio li, .anno.check li, .show.check li").click((function(){var $li=$(this);var id=$li.attr("id");let value;if(!id)return;var group=id.split(".")[0];switch(group){case"mode":if($li.hasClass("checked")){$("ul.anno, div.anno").show();Anno.syncAnnotation();Anno.drawShapes()}else{Text.hide();$("ul.anno, div.anno").hide()}break;case"annotation":case"masking":const handler=Anno.tracker.createHandler;handler.setShapeId(id);Anno.curHandler=handler;break;case"zindex":const shapes=Anno.shapes;switch(id.split(".")[1]){case"front":shapes.sort(((a,b)=>a.selected!=b.selected?a.selected?1:-1:0));break;case"forward":shapes.forEachSelectedReverse(((shape,index,array)=>{if(index<array.length-1&&!array[index+1].selected){array.swap(index,index+1)}}));break;case"backward":shapes.forEachSelected(((shape,index,array)=>{if(index>0&&!array[index-1].selected){array.swap(index,index-1)}}));break;case"back":shapes.sort(((a,b)=>a.selected!=b.selected?a.selected?-1:0:0));break}Anno.drawShapes();break;case"bold":value=$li.hasClass("checked");Anno.shapes.forEachSelected((function(shape){if(shape.font){shape.font.bold=value}}));Anno.drawShapes();break;case"italic":value=$li.hasClass("checked");Anno.shapes.forEachSelected((function(shape){if(shape.font){shape.font.italic=value}}));Anno.drawShapes();break;case"underline":value=$li.hasClass("checked");Anno.shapes.forEachSelected((function(shape){if(shape.textDecoration){shape.textDecoration.underline=value}}));Anno.drawShapes();break;case"lineThrough":value=$li.hasClass("checked");Anno.shapes.forEachSelected((function(shape){if(shape.textDecoration){shape.textDecoration.lineThrough=value}}));Anno.drawShapes();break;case"clearAll":if(confirm("모든 주석을 삭제하시겠습니까?")){Anno.shapes.clear();Anno.shapes.redraw()}break;case"show":value=$li.hasClass("checked");switch(id.split(".")[1]){case"masking":Anno.shapes.doDrawMasking=value;break;case"annotation":Anno.shapes.doDrawAnnotation=value;break;default:console.log("click show id:",id,$li);return}Anno.shapes.redraw();break;case"save":const json=Anno.getJson();$view.triggerEvent("save",$view.getImgUrl(),$view.getPage(),json);break;default:console.log("click id:",id,$li);break}}));window.addEventListener("resize",(function(e){if(AnnoToolbar.isEditMode()){Anno.syncAnnotation();Anno.drawShapes()}const ratio=$view.setCurRatio();$("#imageRatio").text(Math.floor(ratio*100))}));$(".colorpicker").spectrum({showPalette:true,showPaletteOnly:true,togglePaletteOnly:true,hideAfterPaletteSelect:true,showButtons:true,showInput:true,preferredFormat:"hex",maxSelectionSize:2,palette:[["#FFFFFF","#c0c0c0"],["#808080","#000000"],["#ff0000","#ffff00"],["#808000","#00ff00"],["#00ffff","#008080"],["#0000ff","#000080"],["#ffc0cb","#ff00ff"],["#800080","rgba(255,255,255, 0)"]],showAlpha:true,disabled:true,change:function(color){const id=this.id;Anno.shapes.forEachSelected((function(shape){console.log(id,shape[id]);if(shape[id]){shape[id]=color.toHex8String()}}));Anno.drawShapes()}});$("#lineWidth").change((function(){const max=parseInt($(this).attr("max"));const min=parseInt($(this).attr("min"));const width=this.value>max?max:this.value<min?min:this.value;if(width!=this.value)this.value=width;Anno.shapes.forEachSelected((function(shape){if(shape.lineWidth){shape.lineWidth=width}}));Anno.drawShapes()}));$("#lineDash").change((function(){const dash=this.value;Anno.shapes.forEachSelected((function(shape){if(shape.lineDash){shape.lineDash=dash}}));Anno.drawShapes()}));$("#lineCapHeadSize").change((function(){const value=this.value;Anno.shapes.forEachSelected((function(shape){if(shape.lineCapHead){shape.lineCapHead.setSize(value)}}));Anno.drawShapes()}));$("#lineCapHeadShape").change((function(){const value=this.value;Anno.shapes.forEachSelected((function(shape){if(shape.lineCapHead){shape.lineCapHead.setShape(value)}}));Anno.drawShapes()}));$("#lineCapTailSize").change((function(){const value=this.value;Anno.shapes.forEachSelected((function(shape){if(shape.lineCapTail){shape.lineCapTail.setSize(value)}}));Anno.drawShapes()}));$("#lineCapTailShape").change((function(){const value=this.value;Anno.shapes.forEachSelected((function(shape){if(shape.lineCapTail){shape.lineCapTail.setShape(value)}}));Anno.drawShapes()}));$("#fontSize").change((function(){const value=parseInt(this.value);Anno.shapes.forEachSelected((function(shape){if(shape.font){shape.font.size=value}}));Anno.drawShapes()}));$("#fontFamily").change((function(){const value=this.value;Anno.shapes.forEachSelected((function(shape){if(shape.font){shape.font.family=value}}));Anno.drawShapes()}));$("#textAlign").change((function(){const value=this.value;Anno.shapes.forEachSelected((function(shape){if(shape.textAlign){shape.textAlign=value}}));Anno.drawShapes()}));$("#stampText").change((function(){const value=this.value;Anno.shapes.forEachSelected((function(shape){if(shape.constructor.name=="Stamp"){shape.text=value}}));Anno.drawShapes()}))}static setChecked(id,value){if(value){$(id).addClass("checked")}else{$(id).removeClass("checked")}}static isChecked=id=>$(id).hasClass("checked");static isEditMode=_=>AnnoToolbar.isChecked("#mode");static getHex6(color){return color.length==9&&color.startsWith("#")&&color.endsWith("ff")?color.substring(0,7):color}static setShapeToolbar(shape,single=true){if(shape.fillStyle){$("#fillStyle").spectrum("set",AnnoToolbar.getHex6(shape.fillStyle));$("#fillStyle").spectrum("enable")}else{if(single)$("#fillStyle").spectrum("disable")}if(shape.strokeStyle){$("#strokeStyle").spectrum("set",AnnoToolbar.getHex6(shape.strokeStyle));$("#strokeStyle").spectrum("enable")}else{if(single)$("#strokeStyle").spectrum("disable")}if(shape.lineWidth){$("#lineWidth").val(shape.lineWidth);$("#lineWidth").prop("disabled",false)}else{if(single)$("#lineWidth").prop("disabled",true)}if(shape.lineDash){const dropDown=$("#lineDash")[0].msDropdown;dropDown.disabled=false;dropDown.value=shape.lineDash}else{if(single){const dropDown=$("#lineDash")[0].msDropdown;dropDown.disabled=true}}if(shape.lineCapHead){$("#lineCapHeadSize").val(shape.lineCapHead.getSize());$("#lineCapHeadSize").prop("disabled",false);const dropDown=$("#lineCapHeadShape")[0].msDropdown;dropDown.disabled=false;dropDown.value=shape.lineCapHead.getShape()}else{if(single){$("#lineCapHeadSize").prop("disabled",true);const dropDown=$("#lineCapHeadShape")[0].msDropdown;dropDown.disabled=true}}if(shape.lineCapTail){$("#lineCapTailSize").val(shape.lineCapTail.getSize());$("#lineCapTailSize").prop("disabled",false);const dropDown=$("#lineCapTailShape")[0].msDropdown;dropDown.disabled=false;dropDown.value=shape.lineCapTail.getShape()}else{if(single){$("#lineCapTailSize").prop("disabled",true);const dropDown=$("#lineCapTailShape")[0].msDropdown;dropDown.disabled=true}}if(shape.constructor.name=="Text"){const font=shape.font;$("#fontColor").spectrum("set",AnnoToolbar.getHex6(shape.fontColor));$("#fontColor").spectrum("enable");$("#fontSize").val(font.size);$("#fontSize").prop("disabled",false);$("#fontFamily").val(font.family);$("#fontFamily").prop("disabled",false);const dropDown=$("#textAlign")[0].msDropdown;dropDown.disabled=false;dropDown.value=shape.textAlign;$(".font-style li.disabled").removeClass("disabled");this.setChecked("#italic",font.italic);this.setChecked("#bold",font.bold);const textDecoration=shape.textDecoration;this.setChecked("#underline",textDecoration.underline);this.setChecked("#lineThrough",textDecoration.lineThrough)}else{if(single){$("#fontColor").spectrum("disable");$("#fontSize").prop("disabled",true);$("#fontFamily").prop("disabled",true);const dropDown=$("#textAlign")[0].msDropdown;dropDown.disabled=true;$(".font-style li").addClass("disabled")}}if(shape.constructor.name=="Stamp"){$("#stampText").val(shape.text);$("#stampText").prop("disabled",false)}else{if(single){$("#stampText").prop("disabled",true);$("#stampText").val("")}}}static toolbarUpdateHandler(){const canvas=document.getElementById("sfanno");canvas.addEventListener("mouseup",(function(e){const $checked=$("ul.create li.checked");if($checked.length!=0){$checked.removeClass("checked");Anno.curHandler=Anno.tracker.selectHandler;AnnoToolbar.setShapeToolbar(Anno.getCreatedShape(),true)}else{AnnoToolbar.setShapeToolbar("",true);const single=Anno.shapes.getSelectedCount()==1;Anno.shapes.forEachSelected((function(shape){AnnoToolbar.setShapeToolbar(shape,single)}))}}))}}